% image points of 16 objects
xx = cat(3, [0.982278, 0.654974; 0.0927022, 0.621608; 0.51598, 0.652131; 0.815151, 0.794159], [0.683716, 0.893754; 0.690954, 0.801508; 0.513903, 0.77105; 0.270153, 0.81729], [0.987845, 0.724102; 0.249982, 0.518902; 0.0939525, 0.756671; 0.998735, 0.81531], [0.174621, 0.221215; 0.031591, 0.981922; 0.463034, 0.542612; 0.689593, 0.00593966], [2.36498, 2.26119; 3.09548, 2.18342; 2.82705, 1.79886; 1.72202, 1.3576], [0.952103, 0.181805; 0.201891, 0.755035; 0.0404929, 0.991375; 0.142045, 0.300039], [0.828266, 0.550457; 2.97736, 1.0451; 2.06087, 1.45868; 0.707412, 1.38513], [0.295887, 0.382059; 0.592567, 0.448915; 0.781985, 0.611009; 0.322414, 0.631625], [3.16015, 2.69979; 1.80669, 1.01887; 2.36397, 0.944576; 3.44466, 2.81278], [2.9472, 2.61953; 1.95753, 0.807012; 2.47237, 1.68409; 3.19763, 2.42446], [1.44206, 0.973833; 1.93931, 1.63405; 2.61501, 2.17498; 2.21729, 1.27645], [0.44206, 0.973833; 1.93931, 1.63405; 2.31501, 2.17498; 1.21729, 1.27645], [1.49752, 2.08601; 2.467, 1.15882; 3.01462, 1.07236; 1.04216, 0.584129], [1.31971, 1.41104; 0.944039, 0.333689; 1.72467, 0.642306; 2.05703, 1.98103], [3.36498, 2.26119; 3.09548, 2.18342; 2.82705, 1.79886; 2.72202, 1.3576], [0.164621, 0.221215; 0.031591, 0.981922; 0.463034, 0.532612; 0.689593, 0.00593966]);

% plot image points of 16 objects
for i=1:16
    subplot(4,4,i);
    plot([xx(:,1,i); xx(1,1,i)], [xx(:,2,i); xx(1,2,i)]); 
end

% Add your program after this line

% 交点を求める
crossPoints = zeros(16, 2, 'like', xx);
for i=1:16
    x1 = xx(1, :, i);
    x2 = xx(2, :, i);
    x3 = xx(3, :, i);
    x4 = xx(4, :, i);
    xc = crosspoint(x1, x2, x3, x4);
    crossPoints(i, :) = xc;
end

% 不変量を求める
invariantValues = zeros(16, 1, 'double');
for i=1:16
    x1 = xx(1, :, i);
    x2 = xx(2, :, i);
    x3 = xx(3, :, i);
    x4 = xx(4, :, i);
    x5 = crossPoints(i, :);
%     figure
%     hold on
%     plot([xx(:,1,i); xx(1,1,i)], [xx(:,2,i); xx(1,2,i)]); 
%     plot(x5(1, 1), x5(1, 2), '.r');
%     hold off
    l15 = norm(x5-x1);
    l12 = norm(x2-x1);
    invariantValues(i) = l12/l15;
end

% 一致評価
flagMatrix = zeros(16, 16, 'logical');
for i=1:16
    invariantValue_i = invariantValues(i);
    for j=i+1:16
        invariantValue_j = invariantValues(j);
        diff_ij = abs(invariantValue_i - invariantValue_j);
        threshold = (abs(invariantValue_i) + abs(invariantValue_j)) * 0.001;
        if diff_ij < threshold
            flagMatrix(i, j) = true;
            disp([i j])
        end
    end
end